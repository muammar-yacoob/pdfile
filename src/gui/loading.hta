<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>PDFile Loading</title>
<hta:application
  id="PDFileLoader"
  applicationName="PDFile"
  icon="img/logo.ico"
  border="none"
  borderStyle="normal"
  caption="no"
  innerBorder="no"
  maximizeButton="no"
  minimizeButton="no"
  showInTaskbar="yes"
  singleInstance="yes"
  scroll="no"
  contextMenu="no"
  selection="no"
  sysmenu="no"
/>
<style>
  *{margin:0;padding:0;cursor:default}
  html,body{height:100%;width:100%;background:#000;overflow:hidden}
  body{display:flex;flex-direction:column;background-image:url('img/pdfile-loading-bg.png');background-size:cover;background-position:center;background-repeat:no-repeat;font-family:Segoe UI,sans-serif;color:#fff;opacity:1;transition:opacity .3s ease-out;border:none;box-sizing:border-box;justify-content:flex-end}
  body.fade-out{opacity:0}
  .tagline{position:absolute;top:90px;left:100px;right:0;text-align:left;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:clip;z-index:100}
  .footer{padding:20px 16px 16px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
  .website{font-size:13px;color:#fff;text-decoration:none;font-weight:600;transition:opacity .2s;cursor:pointer}
  .website:hover{opacity:0.8;text-decoration:none}
</style>
<script language="javascript">
  var w = 320, h = 400;  // Compact loading window
  window.resizeTo(w, h);
  window.moveTo((screen.availWidth - w) / 2, (screen.availHeight - h) / 2);

  // Drag support for borderless window
  var isDragging = false, dragX = 0, dragY = 0;

  // Taglines
  var taglines = [
    "No Safe Word for PDFs.",
    "File Discipline, Delivered.",
    "Dominate Your Documents.",
    "Split. Merge. Repeat.",
    "Turn Your PDFs Inside Out.",
    "Your PDFs, Your Rules.",
    "Because We Hate PDFs.",
    "Commit Document Crimes.",
    "Because PDFs Deserve Consequences."
  ];

  window.onload = function() {
    // Set random tagline
    var randomTagline = taglines[Math.floor(Math.random() * taglines.length)];
    var taglineEl = document.getElementById('tagline');
    if (taglineEl) {
      taglineEl.innerText = randomTagline;

      // Auto-size font to fit available width
      var maxWidth = 190; // Available width (320 - 100 left margin - 30 right margin)
      var maxFontSize = 16; // Maximum font size
      var minFontSize = 10; // Minimum font size

      // Create temporary element to measure text width
      var measure = document.createElement('span');
      measure.style.visibility = 'hidden';
      measure.style.position = 'absolute';
      measure.style.whiteSpace = 'nowrap';
      measure.style.fontWeight = '700';
      measure.style.fontFamily = 'Segoe UI, sans-serif';
      measure.innerText = randomTagline;
      document.body.appendChild(measure);

      // Binary search for optimal font size
      var fontSize = maxFontSize;
      measure.style.fontSize = fontSize + 'px';

      while (measure.offsetWidth > maxWidth && fontSize > minFontSize) {
        fontSize -= 0.5;
        measure.style.fontSize = fontSize + 'px';
      }

      taglineEl.style.fontSize = fontSize + 'px';
      document.body.removeChild(measure);
    }

    document.body.onmousedown = function(e) {
      isDragging = true;
      dragX = e.screenX - window.screenLeft;
      dragY = e.screenY - window.screenTop;
    };
    document.body.onmousemove = function(e) {
      if (isDragging) {
        window.moveTo(e.screenX - dragX, e.screenY - dragY);
      }
    };
    document.body.onmouseup = function() { isDragging = false; };
    document.body.onmouseleave = function() { isDragging = false; };
  };

  var fso = new ActiveXObject("Scripting.FileSystemObject");
  var shell = new ActiveXObject("WScript.Shell");
  var tempDir = shell.ExpandEnvironmentStrings("%TEMP%");
  var readyFile = tempDir + "\\pdfile-ready.tmp";
  var logFile = tempDir + "\\pdfile-loading.log";
  var pollTimer = null;
  var isClosing = false;
  var animProgress = 0;

  function log(msg) {
    try {
      var f = fso.OpenTextFile(logFile, 8, true);
      f.WriteLine(new Date().toISOString() + " | " + msg);
      f.Close();
    } catch(e) {}
  }

  // Clear previous log
  try { fso.DeleteFile(logFile); } catch(e) {}
  log("=== HTA STARTED ===");

  function closeHTA() {
    log("closeHTA()");
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    try { fso.DeleteFile(readyFile); } catch(e) {}
    self.close();
  }

  function fadeAndClose() {
    log("fadeAndClose() - Edge already launched by server");
    if (isClosing) return;
    isClosing = true;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    try { fso.DeleteFile(readyFile); } catch(e) {}

    // Fade out and close (Edge is already running)
    document.body.className = 'fade-out';
    setTimeout(closeHTA, 300);
  }

  // Failsafe timeout
  setTimeout(function() {
    if (!isClosing) {
      log("FAILSAFE TIMEOUT");
      closeHTA();
    }
  }, 30000);

  // Poll for ready signal
  setTimeout(function() {
    log("Poll started");
    pollTimer = setInterval(function() {
      if (fso.FileExists(readyFile)) {
        log("Ready file found - Edge already launched, closing HTA");
        fadeAndClose();
      }
    }, 80);
  }, 100);

  // Handle website link click
  function openWebsite() {
    try {
      var ps = new ActiveXObject('WScript.Shell');
      ps.Run('powershell.exe -WindowStyle Hidden -Command "Start-Process https://pdfile.co"', 0, false);
    } catch(e) {
      log("Error opening website: " + e.message);
    }
    return false;
  }
</script>
</head>
<body>
  <div class="tagline" id="tagline"></div>
  <div class="footer">
    <a class="website" href="#" onclick="return openWebsite()">pdfile.co</a>
  </div>
</body>
</html>
